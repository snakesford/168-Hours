<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">
  <title>168 Hours</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
/* === CSS Variables === */
:root {
  --bg-primary: #fafaf9;
  --bg-secondary: #f5f5f4;
  --bg-card: #ffffff;
  --text-primary: #1c1917;
  --text-secondary: #57534e;
  --text-muted: #a8a29e;
  --border: #e7e5e4;
  --border-hover: #d6d3d1;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --danger: #dc2626;
  --danger-hover: #b91c1c;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --font-sans: 'Outfit', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

/* === Reset === */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* === Base === */
html {
  font-size: 14px;
  -webkit-text-size-adjust: 100%;
  height: 100%;
  overflow: hidden;
}

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.5;
  height: 100dvh;
  min-height: 100dvh;
  /* Prevent pull-to-refresh on iOS */
  overscroll-behavior: none;
  overflow: hidden;
  /* Safe area padding for notched devices */
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  padding-bottom: env(safe-area-inset-bottom);
}

/* === App Layout === */
#app {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;
  overflow: hidden;
}

/* === Version === */
#version {
  position: fixed;
  bottom: 0;
  left: 0;
  padding: 0.5rem;
  padding-left: max(0.5rem, env(safe-area-inset-left));
  padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  opacity: 0.3;
  pointer-events: none;
  z-index: 1000;
  line-height: 1;
  user-select: none;
}


/* === Header === */
.header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 10rem;
  padding: 1rem 1.5rem;
  padding-top: max(1rem, env(safe-area-inset-top));
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text-primary);
}

.logo span {
  font-weight: 400;
  color: var(--text-secondary);
}

.logo .tagline {
  font-weight: 400;
  color: var(--text-secondary);
  font-size: 0.9em;
  margin-left: 0.25em;
}

.nav-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text-primary);
  white-space: nowrap;
}

.type-total-pill {
  font-family: var(--font-mono);
  font-size: 0.62rem;
  line-height: 1;
  padding: 0.2rem 0.35rem;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  white-space: nowrap;
}

.type-totals-side {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  padding: 0.5rem 0.1rem 0 0.1rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-card);
  overflow: hidden;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  margin-left: auto;
}

/* === Buttons === */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  font-family: var(--font-sans);
  font-size: 0.875rem;
  font-weight: 500;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.15s ease;
  user-select: none;
}

.btn:hover:not(:disabled) {
  border-color: var(--border-hover);
  background: var(--bg-secondary);
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.btn-icon {
  padding: 0.5rem;
  width: 36px;
  height: 36px;
}

.btn-labeled {
  flex-direction: column;
  padding: 0.375rem 0.5rem;
  min-width: 48px;
  gap: 0.125rem;
}

.btn-labeled span {
  font-size: 0.625rem;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  color: var(--text-secondary);
}

.btn-labeled:hover span {
  color: var(--text-primary);
}

.btn-labeled.active span,
.btn-labeled.btn-danger span {
  color: inherit;
}

.btn-primary {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--accent-hover);
  border-color: var(--accent-hover);
}

.btn-danger {
  color: var(--danger);
  border-color: var(--danger);
  background: var(--bg-card);
}

.btn-danger:hover:not(:disabled) {
  background: var(--danger);
  color: white;
  border-color: var(--danger-hover);
}

.btn-add {
  width: 100%;
  border-color: var(--border);
  color: var(--text-secondary);
  background: var(--bg-card);
}

.btn-add:hover:not(:disabled) {
  color: var(--text-primary);
  border-color: var(--border-hover);
  background: var(--bg-secondary);
}


.btn-icon.active,
.btn-labeled.active {
  background: var(--text-primary);
  color: var(--bg-card);
  border-color: var(--text-primary);
}

.btn-icon.active:hover:not(:disabled),
.btn-labeled.active:hover:not(:disabled) {
  background: var(--text-secondary);
  border-color: var(--text-secondary);
}

/* === Main Layout === */
.main {
  display: flex;
  flex: 1;
  min-height: 0;
  gap: 1.5rem;
  padding: 1.5rem;
  overflow: hidden;
}

/* === Sidebar === */
.sidebar {
  width: var(--sidebar-width, 280px);
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  min-height: 0;
  gap: 1rem;
  position: relative;
}

.sidebar-toggle {
  display: none;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.sidebar-toggle:hover {
  border-color: var(--border-hover);
  background: var(--bg-secondary);
}

.sidebar-content {
  display: flex;
  flex-direction: column;
  min-height: 0;
  gap: 1rem;
}

/* === Resize Handle === */
.resize-handle {
  width: 4px;
  flex-shrink: 0;
  cursor: col-resize;
  background: transparent;
  transition: background 0.15s ease;
  position: relative;
}

.resize-handle:hover {
  background: var(--border);
}

.resize-handle::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 0;
  bottom: 0;
  width: 2px;
  transform: translateX(-50%);
  background: var(--border);
  opacity: 0;
  transition: opacity 0.15s ease;
}

.resize-handle:hover::after {
  opacity: 1;
}

.legend {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  gap: 0.25rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 0.75rem;
  overflow: hidden;
  max-height: none;
}

.legend-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.category-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.type-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.type-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
}

.type-pill {
  font-size: 0.65rem;
  line-height: 1;
  padding: 0.3rem 0.45rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  background: var(--bg-card);
}

.btn-secondary {
  border-color: var(--border);
  color: var(--text-secondary);
  background: var(--bg-card);
}

.btn-secondary:hover:not(:disabled) {
  color: var(--text-primary);
  border-color: var(--border-hover);
  background: var(--bg-secondary);
}

.category-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background 0.15s ease;
}

.category-item:hover {
  background: var(--bg-secondary);
}

.category-item.active {
  background: var(--bg-secondary);
  box-shadow: inset 0 0 0 2px var(--text-primary);
}

.category-item.merge-selected {
  background: rgba(59, 130, 246, 0.12);
  box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.45);
}

.category-item.category-group {
  cursor: default;
}

.category-color-wrapper {
  position: relative;
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.category-color {
  width: 20px;
  height: 20px;
  border-radius: var(--radius-sm);
  flex-shrink: 0;
  border: 1px solid rgba(0,0,0,0.1);
  cursor: pointer;
}

.category-color.category-color-group {
  border: none;
  border-radius: 8px;
}

.category-color::-webkit-color-swatch-wrapper {
  padding: 0;
}

.category-color::-webkit-color-swatch {
  border: none;
  border-radius: var(--radius-sm);
}

.category-info {
  flex: 1;
  min-width: 0;
}

.category-members {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  margin-top: 0.35rem;
}

.category-member {
  display: inline-flex;
  align-items: center;
  gap: 0.2rem;
  padding: 0.1rem 0.3rem;
  border-radius: 999px;
  border: 1px solid transparent;
  background: rgba(0, 0, 0, 0.04);
  font-size: 0.6875rem;
  color: var(--text-secondary);
}

.category-member-select {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  border: 1px solid transparent;
  border-radius: 999px;
  background: none;
  font: inherit;
  color: inherit;
  cursor: pointer;
  padding: 0.05rem 0.2rem;
}

.category-member-remove {
  border: none;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.1rem;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
}

.category-member-remove:hover {
  color: var(--danger);
  background: rgba(220, 38, 38, 0.12);
}

.category-member:hover,
.category-member:focus-within {
  background: rgba(0, 0, 0, 0.08);
  color: var(--text-primary);
}

.category-member-select.active {
  border-color: rgba(37, 99, 235, 0.4);
  background: rgba(37, 99, 235, 0.12);
  color: var(--text-primary);
}

.category-member-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  flex-shrink: 0;
}

.category-name {
  font-size: 11px;
  font-weight: 500;
  white-space: nowrap;
}

.category-name-input {
  font-family: var(--font-sans);
  font-size: 0.8125rem;
  font-weight: 500;
  border: none;
  background: transparent;
  outline: none;
  width: 100%;
  padding: 0;
}

.category-stats {
  font-family: var(--font-mono);
  font-size: 0.6875rem;
  color: var(--text-muted);
}

.category-type-tags{display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.28rem;opacity:0.9}
.category-type-tag{font-family:var(--font-sans);font-size:0.56rem;line-height:1;border:1px solid rgba(0,0,0,0.08);border-radius:999px;background:rgba(0,0,0,0.02);color:var(--text-muted);padding:0.1rem 0.28rem;cursor:pointer}
.category-type-tag:hover{border-color:var(--border);color:var(--text-secondary);background:rgba(0,0,0,0.04)}
.category-type-tag.active{border-color:rgba(37,99,235,0.35);color:#1d4ed8;background:rgba(59,130,246,0.12)}

.category-type-select {
  margin-top: 0.35rem;
  width: 100%;
  font-family: var(--font-sans);
  font-size: 0.68rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-secondary);
  padding: 0.2rem 0.35rem;
}

.category-type-select:focus {
  outline: none;
  border-color: var(--accent);
}

.category-randomize {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 16px;
  height: 16px;
  padding: 0;
  border: 1.5px solid var(--bg-card);
  background: var(--bg-card);
  border-radius: 999px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.15s ease;
  flex-shrink: 0;
  z-index: 1;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.category-randomize svg {
  width: 10px;
  height: 10px;
}

.category-edit,
.category-delete {
  opacity: 0;
  padding: 0.25rem;
  border: none;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.15s ease;
  flex-shrink: 0;
}

.category-merge,
.category-unmerge {
  opacity: 0;
  padding: 0.25rem;
  border: none;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.15s ease;
  flex-shrink: 0;
}

.category-group-add {
  opacity: 0;
  padding: 0.25rem;
  border: none;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.15s ease;
  flex-shrink: 0;
}

.category-item:hover .category-group-add {
  opacity: 1;
}

.category-group-add:hover {
  color: var(--accent);
  background: rgba(37, 99, 235, 0.1);
}

.category-item:hover .category-merge,
.category-item:hover .category-unmerge {
  opacity: 1;
}

.category-merge:hover {
  color: var(--accent);
  background: rgba(37, 99, 235, 0.1);
}

.category-unmerge:hover {
  color: #8b5cf6;
  background: rgba(139, 92, 246, 0.12);
}

.category-item:hover .category-randomize,
.category-item:hover .category-edit,
.category-item:hover .category-delete {
  opacity: 1;
}

.category-randomize:hover {
  color: #8b5cf6;
  background: var(--bg-card);
  border-color: #8b5cf6;
  box-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);
}

.category-edit:hover {
  color: var(--accent);
  background: rgba(37, 99, 235, 0.1);
}

.category-delete:hover {
  color: var(--danger);
  background: rgba(220, 38, 38, 0.1);
}

.week-start-section {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 0.5rem;
  margin-top: 0.5rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
}

.week-start-setting {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.week-start-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  white-space: nowrap;
  min-width: 5rem;
}

.week-start-select {
  flex: 1;
  padding: 0.375rem 0.5rem;
  font-family: var(--font-sans);
  font-size: 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-primary);
  cursor: pointer;
  outline: none;
}

.week-start-select:hover {
  border-color: var(--border-hover);
}

.week-start-select:focus {
  border-color: var(--accent);
}

/* === Grid Container === */
/* Letter paper: 8.5" x 11" = aspect ratio 0.773 */
.grid-container {
  width: auto;
  max-width: min(100%, 680px);
  height: 100%;
  max-height: 100%;
  aspect-ratio: 8.5 / 11;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  flex-shrink: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.grid-header {
  display: flex;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
}

.hour-label-spacer {
  width: 36px;
  flex-shrink: 0;
}

.day-labels {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  flex: 1;
  text-align: center;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: var(--text-secondary);
  padding: 0.5rem 0;
}

.grid-body {
  display: flex;
  flex: 1;
  overflow: hidden;
  min-height: 0;
}

.hour-labels {
  width: 36px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 1px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  padding-top: 1px;
}

.hour-label {
  flex: 1;
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  padding-right: 0.5rem;
  padding-top: 2px;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-primary);
}

/* === Grid === */
.grid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: repeat(24, 1fr);
  gap: 1px;
  background: var(--border);
  padding: 1px;
}

/* Mobile styles */
@media (max-width: 768px) {
  /* Header adjustments */
  .header {
    flex-wrap: wrap;
    padding: 0.75rem 1rem;
    gap: 0.5rem;
  }
  
  .logo {
    font-size: 1.25rem;
  }

  .nav-title {
    width: 100%;
    font-size: 0.95rem;
    white-space: normal;
  }

  .type-totals-side {
    width: 100%;
    padding-top: 0.35rem;
  }
  
  .header-actions {
    flex-wrap: wrap;
    gap: 0.375rem;
    width: 100%;
    justify-content: flex-start;
  }
  
  .btn-labeled {
    padding: 0.25rem 0.375rem;
    min-width: 44px;
    font-size: 0.75rem;
  }
  
  .btn-labeled span {
    font-size: 0.5rem;
  }
  
  /* Main layout */
  .main {
    padding: 1rem;
    gap: 1rem;
    flex-direction: column;
  }
  
  /* Sidebar on mobile */
  .sidebar {
    width: 100% !important;
    max-width: 100%;
  }
  
  .sidebar-toggle {
    display: flex;
    position: static;
    align-self: flex-end;
    margin-bottom: 0.5rem;
  }
  
  .sidebar.collapsed .sidebar-content {
    display: none;
  }
  
  .resize-handle {
    display: none;
  }
  
  /* Grid adjustments */
  .grid-body {
    height: calc(100% * 23.5 / 24);
  }
  
  .grid {
    gap: 0.5px;
    padding: 0.5px;
  }
  
  /* Prevent text selection on cells during drag */
  .cell {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  /* Allow text selection in inputs and textareas */
  input,
  textarea,
  button {
    -webkit-user-select: auto;
    user-select: auto;
  }
  
  /* Two-column category layout on mobile */
  .legend {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.25rem;
    max-height: none;
  }
  
  .category-item {
    padding: 0.375rem;
    gap: 0.375rem;
  }
  
  .category-name {
    font-size: 10px;
  }
  
  .category-stats {
    font-size: 0.625rem;
  }
  
  .category-color-wrapper {
    width: 16px;
    height: 16px;
  }

  .category-color {
    width: 16px;
    height: 16px;
  }

  .category-randomize {
    width: 14px;
    height: 14px;
    top: -3px;
    right: -3px;
  }

  .category-randomize svg {
    width: 8px;
    height: 8px;
  }
}

.cell {
  background: var(--bg-card);
  cursor: pointer;
  transition: filter 0.1s ease;
  position: relative;
  overflow: visible;
}

.cell-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 9px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  pointer-events: none;
  white-space: nowrap;
  text-align: center;
  z-index: 1;
}

/* === Cell Chunks (Split Cells) === */
.cell-chunks {
  display: flex;
  width: 100%;
  height: 100%;
  position: relative;
}

.cell-chunk {
  flex: 1;
  position: relative;
  border-right: 1px solid rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: filter 0.1s ease;
}

.cell-chunk:last-child {
  border-right: none;
}

.cell-chunk:hover {
  filter: brightness(0.92);
}

.cell-chunks-2 {
  flex-direction: column;
}

.cell-chunks-2 .cell-chunk {
  border-right: none;
  border-bottom: 1px solid rgba(255, 255, 255, 0.8);
}

.cell-chunks-2 .cell-chunk:last-child {
  border-bottom: none;
}

.cell-chunks-3 {
  flex-direction: column;
}

.cell-chunks-3 .cell-chunk {
  border-right: none;
  border-bottom: 1px solid rgba(255, 255, 255, 0.8);
}

.cell-chunks-3 .cell-chunk:last-child {
  border-bottom: none;
}

.cell-chunks-4 {
  flex-direction: column;
}

.cell-chunks-4 .cell-chunk {
  border-right: none;
  border-bottom: 1px solid rgba(255, 255, 255, 0.8);
}

.cell-chunks-4 .cell-chunk:last-child {
  border-bottom: none;
}

/* === Tracking Mode (Screen) === */
/* Hidden by default - shown when tracking mode is active */
.cell-tracking-top,
.cell-tracking-bottom {
  display: none;
}

/* When tracking mode is active, show the split layout on screen */
.tracking-mode .cell {
  display: flex;
  flex-direction: column;
  background: transparent !important;
}

/* Hide the centered region labels when in tracking mode */
.tracking-mode .cell-label {
  display: none;
}

/* Show tracking structure on screen */
.tracking-mode .cell-tracking-top,
.tracking-mode .cell-tracking-bottom {
  display: flex;
}

.tracking-mode .cell-tracking-top {
  flex: 1;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.tracking-mode .cell-tracking-label {
  font-size: 9px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  padding: 0 4px;
}

.tracking-mode .cell-tracking-bottom {
  flex: 1;
  align-items: center;
  background: var(--bg-card);
  padding: 0 4px;
  gap: 4px;
}

.tracking-mode .cell-tracking-checkbox {
  font-size: 12px;
  line-height: 1;
  flex-shrink: 0;
  color: var(--text-muted);
}

.tracking-mode .cell-tracking-line {
  flex: 1;
  border-bottom: 1px solid var(--border);
  height: 50%;
}

/* === Dialog === */
.dialog {
  border: none;
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  box-shadow: var(--shadow-md), 0 0 0 1px var(--border);
  max-width: 320px;
  width: 100%;
}

.dialog::backdrop {
  background: rgba(0, 0, 0, 0.4);
}

.dialog h2 {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 1rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  font-size: 0.8125rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 0.375rem;
}

.form-group input[type="text"] {
  width: 100%;
  padding: 0.5rem 0.75rem;
  font-family: var(--font-sans);
  font-size: 0.875rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  outline: none;
  transition: border-color 0.15s ease;
}

.form-group input[type="text"]:focus {
  border-color: var(--accent);
}

.form-group input[type="color"] {
  width: 100%;
  height: 40px;
  padding: 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  cursor: pointer;
}

.dialog-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

/* === Scrollbar === */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-hover);
}

/* === Print Styles === */
@media print {
  @page {
    size: letter portrait;
    margin: 0.25in;
  }

  /* Hide interactive elements */
  .header-actions,
  .sidebar,
  .resize-handle,
  .btn,
  .category-randomize,
  .category-edit,
  .category-delete,
  .category-color-wrapper,
  .category-randomize,
  .category-color,
  .dialog {
    display: none !important;
  }

  /* Reset layout for print */
  body {
    background: white;
    font-size: 10px;
    min-height: auto;
    height: auto;
  }

  #app {
    min-height: auto;
    height: auto;
  }

  .header {
    position: static;
    padding: 0.25rem 0;
    border-bottom: 1px solid #000;
    margin-bottom: 0.25rem;
  }

  .logo {
    font-size: 1rem;
  }

  .main {
    display: block;
    padding: 0;
    overflow: visible;
  }

  /* Print grid sizing - fill page exactly */
  .grid-container {
    width: 100% !important;
    max-width: none !important;
    aspect-ratio: auto !important;
    height: auto !important;
    border: 1px solid #000;
    border-radius: 0;
    page-break-inside: avoid;
    box-shadow: none;
  }

  .grid-header {
    background: white;
    border-bottom: 1px solid #000;
  }

  .hour-label-spacer {
    width: 28px;
  }

  .day-labels {
    font-size: 0.7rem;
    padding: 0.4rem 0;
  }

  .grid-body {
    overflow: visible;
  }

  .hour-labels {
    width: 28px;
    background: white;
    border-right: 1px solid #000;
    gap: 0;
    padding-top: 0;
  }

  .hour-label {
    font-size: 0.5rem;
    padding-right: 0.2rem;
    padding-top: 0;
    flex: none;
    height: 32px;
  }

  .grid {
    gap: 0;
    background: white;
    padding: 0;
    grid-template-rows: repeat(24, 32px) !important;
  }

  .cell {
    background: white;
    border: 0.5px solid #ccc;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .cell-label {
    font-size: 8px;
    font-weight: 600;
  }

  /* === Tracking Mode (Print) === */
  /* Adjust sizes for print */
  .tracking-mode .cell-tracking-label {
    font-size: 5px;
    font-weight: 600;
    padding: 0 1px;
  }

  .tracking-mode .cell-tracking-bottom {
    background: white !important;
    padding: 0 1px;
    gap: 1px;
  }

  .tracking-mode .cell-tracking-checkbox {
    font-size: 7px;
    color: #000;
  }

  .tracking-mode .cell-tracking-line {
    border-bottom-color: #999;
  }

  /* Hide legend in print - can be separate page if needed */
  .legend {
    display: none !important;
  }

  /* Ensure colors print */
  * {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* Remove shadows and transitions */
  * {
    box-shadow: none !important;
    text-shadow: none !important;
    transition: none !important;
  }
}

  </style>
</head>
<body>
<div id="app">
    <header class="header">
      <h1 class="logo">168<span>hours</span><span class="tagline">this week â€” spend them deliberately</span></h1>
      <div class="nav-title">Emmett's New Dreadfull Life Plan</div>
      <div class="header-actions">
        <button id="undo-btn" class="btn btn-labeled" title="Undo" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 10h10a5 5 0 0 1 5 5v2M3 10l5 5M3 10l5-5"/>
          </svg>
          <span>Undo</span>
        </button>
        <button id="redo-btn" class="btn btn-labeled" title="Redo" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10H11a5 5 0 0 0-5 5v2M21 10l-5 5M21 10l-5-5"/>
          </svg>
          <span>Redo</span>
        </button>
        <button id="eraser-btn" class="btn btn-labeled" title="Eraser">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/>
            <path d="M22 21H7"/>
            <path d="m5 11 9 9"/>
          </svg>
          <span>Eraser</span>
        </button>
        <button id="erase-all-btn" class="btn btn-labeled btn-danger" title="Erase All">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/>
            <path d="M22 21H7"/>
            <path d="m5 11 9 9"/>
          </svg>
          <span>Clear All</span>
        </button>
        <button id="copy-summary-btn" class="btn btn-labeled" title="Copy ASCII Summary">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          <span>Copy</span>
        </button>
        <button id="export-png-btn" class="btn btn-labeled" title="Save as PNG">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span>PNG</span>
        </button>
        <button id="tracking-mode-btn" class="btn btn-labeled" title="Toggle Tracking Mode (for printing)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <span>Track</span>
        </button>
        <button id="export-calendar-btn" class="btn btn-labeled" title="Export Calendar (Copy)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span>Export</span>
        </button>
        <button id="import-calendar-btn" class="btn btn-labeled" title="Import Calendar (Paste)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span>Import</span>
        </button>
        <button id="share-btn" class="btn btn-labeled" title="Copy Link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
          </svg>
          <span>Share</span>
        </button>
      </div>
    </header>

    <main class="main">
      <aside class="sidebar">
        <button id="sidebar-toggle" class="sidebar-toggle" title="Toggle categories">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
          </svg>
        </button>
        <div class="sidebar-content">
          <div class="legend" id="legend"></div>
          <div id="type-totals" class="type-totals-side"></div>
          <div class="legend-actions">
            <button id="merge-categories-btn" class="btn btn-secondary" disabled>Merge selected</button>
            <button id="clear-merge-selection-btn" class="btn btn-secondary" disabled>Clear selection</button>
          </div>
          <div class="category-actions">
            <button id="add-category-btn" class="btn btn-add">Add Category</button>
            <button id="reset-categories-btn" class="btn btn-danger">Reset Categories and Data</button>
          </div>
          <div class="type-actions">
            <button id="add-type-btn" class="btn btn-secondary">Add Type</button>
            <div id="type-list" class="type-list"></div>
          </div>
          <div class="week-start-section">
            <div class="week-start-setting">
              <label class="week-start-label">Week starts on</label>
              <select id="week-start-select" class="week-start-select">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="7">Sunday</option>
              </select>
            </div>
            <div class="week-start-setting">
              <label class="week-start-label">Day starts at</label>
              <select id="day-start-select" class="week-start-select">
                <option value="0">12am</option>
                <option value="1">1am</option>
                <option value="2">2am</option>
                <option value="3">3am</option>
                <option value="4">4am</option>
                <option value="5" selected>5am</option>
                <option value="6">6am</option>
                <option value="7">7am</option>
                <option value="8">8am</option>
                <option value="9">9am</option>
                <option value="10">10am</option>
                <option value="11">11am</option>
                <option value="12">12pm</option>
                <option value="13">1pm</option>
                <option value="14">2pm</option>
                <option value="15">3pm</option>
                <option value="16">4pm</option>
                <option value="17">5pm</option>
                <option value="18">6pm</option>
                <option value="19">7pm</option>
                <option value="20">8pm</option>
                <option value="21">9pm</option>
                <option value="22">10pm</option>
                <option value="23">11pm</option>
              </select>
            </div>
          </div>
        </div>
      </aside>
      <div class="resize-handle" id="resize-handle"></div>

      <section class="grid-container">
        <div class="grid-header">
          <div class="hour-label-spacer"></div>
          <div class="day-labels" id="day-labels"></div>
        </div>
        <div class="grid-body">
          <div class="hour-labels" id="hour-labels"></div>
          <div class="grid" id="grid"></div>
        </div>
    </main>
  </div>
  <div id="version"></div>

  <dialog id="category-dialog" class="dialog">
    <form method="dialog">
      <h2 id="dialog-title">Add Category</h2>
      <div class="form-group">
        <label for="category-name">Name</label>
        <input type="text" id="category-name" required maxlength="20" autocomplete="off">
      </div>
      <div class="form-group">
        <label for="category-color">Color</label>
        <input type="color" id="category-color">
      </div>
      <div class="dialog-actions">
        <button type="button" class="btn" id="dialog-cancel">Cancel</button>
        <button type="submit" class="btn btn-primary" id="dialog-submit">Add</button>
      </div>
    </form>
  </dialog>
  <script>
var w="unassigned";function NQ(){let J=Math.random(),Q=0.65+Math.random()*0.2,q=0.45+Math.random()*0.15,Z=Q*Math.min(q,1-q),K=(X)=>{let U=(X+J*12)%12,z=q-Z*Math.max(Math.min(U-3,9-U,1),-1);return Math.round(255*z).toString(16).padStart(2,"0")};return`#${K(0)}${K(8)}${K(4)}`}var qJ=[{id:"sleep",name:"Sleep",color:"#6366f1"},{id:"work",name:"Work",color:"#10b981"},{id:"life-ops",name:"Life Ops",color:"#f59e0b"},{id:"health",name:"Health",color:"#ef4444"},{id:"family-partner",name:"Family / Partner",color:"#ec4899"},{id:"social",name:"Social",color:"#8b5cf6"},{id:"personal-growth",name:"Personal Growth",color:"#14b8a6"},{id:"projects",name:"Projects",color:"#f97316"},{id:"leisure",name:"Leisure",color:"#84cc16"},{id:"buffer",name:"Buffer",color:"#0ea5e9"},{id:"unassigned",name:"Unassigned",color:"#9ca3af"}];function n(){let J=Array(168).fill(null).map(()=>["unassigned"]);return{categories:[...qJ.map((J)=>({...J}))],groups:[],grid:Array(168).fill("unassigned"),gridChunks:J,cellChunks:Array(168).fill(1),activeCategoryId:"unassigned",eraserMode:!1,trackingMode:!1,types:[],categoryTypes:{}}}function XJ(){return{past:[],future:[]}}function UJ(J,Q=!1){let Z={grid:Array.isArray(J.grid)&&J.grid.length===168?[...J.grid]:Array(168).fill("unassigned")};if(Q&&Array.isArray(J.categories)&&J.categories.length>0)Z.categories=J.categories.map((K)=>({...K}));if(Q&&Array.isArray(J.groups))Z.groups=J.groups.map((K)=>({...K,memberIds:[...K.memberIds],originalColors:K.originalColors?{...K.originalColors}:{},originalNames:K.originalNames?{...K.originalNames}:{}}));if(Q&&Array.isArray(J.types))Z.types=J.types.map((K)=>({...K}));if(Q&&J.categoryTypes&&typeof J.categoryTypes==="object")Z.categoryTypes={...J.categoryTypes};if(Q&&Array.isArray(J.cellChunks)&&J.cellChunks.length===168)Z.cellChunks=[...J.cellChunks];if(Q&&Array.isArray(J.gridChunks)&&J.gridChunks.length===168)Z.gridChunks=J.gridChunks.map((K)=>Array.isArray(K)?[...K]:[K||"unassigned"]);return Z}function E(J,Q){return J.categories.find((q)=>q.id===Q)}function m(J,Q){let q=0;if(!Array.isArray(J.grid)||!Array.isArray(J.cellChunks)||!Array.isArray(J.gridChunks))return J.grid.filter((z)=>z===Q).length;for(let Z=0;Z<168;Z++){let K=J.cellChunks[Z]||1,X=J.gridChunks[Z]||[J.grid[Z]||"unassigned"];if(K===1){if(J.grid[Z]===Q)q+=1}else{let U=1/K;for(let z=0;z<K;z++){if(X[z]===Q)q+=U}}}return Math.round(q*100)/100}function EJ(J,Q){let q=[...J.past,{grid:[...Q]}];if(q.length>50)q.shift();return{past:q,future:[]}}function v(J,Q){if(!Q||typeof Q!=="object")return console.warn("pushHistoryWithCategories: invalid state, using empty history"),{past:Array.isArray(J?.past)?J.past:[],future:[]};try{let q=UJ(Q,!0),K=[...Array.isArray(J?.past)?J.past:[],q];if(K.length>50)K.shift();return{past:K,future:[]}}catch(q){return console.error("pushHistoryWithCategories error:",q),{past:Array.isArray(J?.past)?J.past:[],future:[]}}}function ZJ(J,Q,q,Z){if(q<0||q>=168)return{state:J,history:Q};if(J.grid[q]===Z)return{state:J,history:Q};let K=EJ(Q,J.grid),X=[...J.grid];return X[q]=Z,{state:{...J,grid:X},history:K}}function TJ(J,Q,q){if(q<0||q>=168)return{state:J,history:Q};if(J.eraserMode)return ZJ(J,Q,q,"unassigned");if(J.grid[q]===J.activeCategoryId)return ZJ(J,Q,q,"unassigned");return ZJ(J,Q,q,J.activeCategoryId)}function DJ(J,Q,q,Z,K){if(!J||typeof J!=="object")J=n();let X=Array.isArray(J.grid)&&J.grid.length===168?[...J.grid]:Array(168).fill("unassigned"),U={categories:Array.isArray(J.categories)?J.categories:[],groups:Array.isArray(J.groups)?J.groups:[],grid:X,cellChunks:Array.isArray(J.cellChunks)&&J.cellChunks.length===168?[...J.cellChunks]:Array(168).fill(1),gridChunks:Array.isArray(J.gridChunks)&&J.gridChunks.length===168?J.gridChunks.map((F)=>Array.isArray(F)?[...F]:[F||"unassigned"]):X.map((F)=>[F||"unassigned"]),activeCategoryId:J.activeCategoryId||"unassigned",eraserMode:J.eraserMode||!1,trackingMode:J.trackingMode||!1,types:Array.isArray(J.types)?J.types:[],categoryTypes:J.categoryTypes&&typeof J.categoryTypes==="object"?{...J.categoryTypes}:{}},z={past:Array.isArray(Q?.past)?Q.past:[],future:Array.isArray(Q?.future)?Q.future:[]},O=v(z,U),V=K;if(!V||typeof V!=="string")try{V=NQ()}catch(F){console.warn("randomColor() failed, using default:",F),V="#9ca3af"}if(typeof q!=="string")throw console.error("addCategory: id must be a string, got:",typeof q,q),Error(`Invalid id parameter: expected string, got ${typeof q}`);if(typeof Z!=="string")throw console.error("addCategory: name must be a string, got:",typeof Z,Z),Error(`Invalid name parameter: expected string, got ${typeof Z}`);if(Z===q)throw console.error("BUG DETECTED: name and id are the same!",{id:q,name:Z,color:V}),Error(`Category name "${Z}" equals the id - this is a bug!`);let W={id:q,name:Z,color:V},j=Array.isArray(U.categories)?[...U.categories,W]:[W];if(W.name!==Z||W.id!==q)console.error("BUG: Category properties don't match inputs!",{inputId:q,inputName:Z,categoryId:W.id,categoryName:W.name});return{state:{categories:j,groups:U.groups,grid:X,cellChunks:U.cellChunks,gridChunks:U.gridChunks,activeCategoryId:U.activeCategoryId,eraserMode:U.eraserMode,trackingMode:U.trackingMode,types:U.types,categoryTypes:U.categoryTypes},history:O}}function vJ(J,Q,q,Z){let K=v(Q,J);return{state:{...J,categories:J.categories.map((X)=>X.id===q?{...X,name:Z}:X)},history:K}}function zJ(J,Q,q,Z){let K=v(Q,J);return{state:{...J,categories:J.categories.map((X)=>X.id===q?{...X,color:Z}:X)},history:K}}function BJ(J,Q,q){if(q==="unassigned")return{state:J,history:Q};if(!E(J,q))return{state:J,history:Q};let Z=v(Q,J),K=J.grid.map((j)=>j===q?"unassigned":j),X=J.categories.filter((j)=>j.id!==q),U=new Map,O=J.groups.map((j)=>({...j,memberIds:j.memberIds.filter((F)=>F!==q)})).map((j)=>({...j,originalColors:{...j.originalColors},primaryMemberId:j.primaryMemberId})).filter((j)=>{if(j.memberIds.length>=2){if(delete j.originalColors[q],j.primaryMemberId===q)j.primaryMemberId=j.memberIds[0];return!0}for(let F of j.memberIds){let A=j.originalColors[F];if(A)U.set(F,A)}return!1}),V=X.map((j)=>{let F=U.get(j.id);return F?{...j,color:F}:j}),W=J.activeCategoryId===q?"unassigned":J.activeCategoryId;return{state:{...J,categories:V,groups:O,grid:K,activeCategoryId:W,categoryTypes:Object.fromEntries(Object.entries(J.categoryTypes&&typeof J.categoryTypes==="object"?J.categoryTypes:{}).filter(([j])=>j!==q))},history:Z}}function SJ(J,Q,q,Z,K,X,U,z){if(!Array.isArray(K)||K.length<2)return{state:J,history:Q};let O=Array.from(new Set(K)),V=new Set(J.categories.map((R)=>R.id)),W=O.filter((R)=>V.has(R)&&R!=="unassigned");if(W.length<2)return{state:J,history:Q};let j=v(Q,J),F=J.groups.map((R)=>({...R,memberIds:R.memberIds.filter((H)=>!W.includes(H))})).filter((R)=>R.memberIds.length>=2),A={},k={},P=J.categories.map((R)=>{if(W.includes(R.id)){A[R.id]=R.color,k[R.id]=R.name;let H=X[R.id];if(H)return{...R,color:H}}return R}),_={id:q,name:Z,memberIds:W,originalColors:A,originalNames:k,color:U,primaryMemberId:z};return{state:{...J,categories:P,groups:[...F,_]},history:j}}function YJ(J,Q,q,Z,K){if(!J.groups.find((V)=>V.id===q))return{state:J,history:Q};let U=v(Q,J),z=J.categories.map((V)=>{let W=K[V.id];return W?{...V,color:W}:V}),O=J.groups.map((V)=>V.id===q?{...V,color:Z}:V);return{state:{...J,categories:z,groups:O},history:U}}function xJ(J,Q,q,Z){if(!J.groups.some((z)=>z.id===q))return{state:J,history:Q};let X=v(Q,J),U=J.groups.map((z)=>z.id===q?{...z,name:Z}:z);return{state:{...J,groups:U},history:X}}function wJ(J,Q,q,Z,K,X){let U=J.groups.find((k)=>k.id===q);if(!U)return{state:J,history:Q};let z=Z.filter((k)=>k!=="unassigned");if(z.length===0)return{state:J,history:Q};let O=v(Q,J),V=Array.from(new Set([...U.memberIds,...z])),W={...U.originalColors},j={...U.originalNames},F=J.categories.map((k)=>{if(z.includes(k.id)&&!W[k.id])W[k.id]=k.color,j[k.id]=k.name;let P=K[k.id];return P?{...k,color:P}:k}),A=J.groups.map((k)=>k.id===q?{...k,memberIds:V,originalColors:W,originalNames:j,primaryMemberId:X}:k);return{state:{...J,categories:F,groups:A},history:O}}function VJ(J,Q,q,Z,K,X){let U=J.groups.find((P)=>P.id===q);if(!U)return{state:J,history:Q};if(!U.memberIds.includes(Z))return{state:J,history:Q};let z=v(Q,J),O=U.memberIds.filter((P)=>P!==Z),V=U.originalColors[Z],W=U.originalNames[Z],j={...U.originalColors},F={...U.originalNames};if(delete j[Z],delete F[Z],O.length<2){let P=J.categories.map((_)=>{let R=j[_.id];if(R){let H=F[_.id];return{..._,color:R,name:H??_.name}}if(_.id===Z&&V)return{..._,color:V,name:W??_.name};return _});return{state:{...J,categories:P,groups:J.groups.filter((_)=>_.id!==q)},history:z}}let A=J.categories.map((P)=>{if(P.id===Z&&V)return{...P,color:V,name:W??P.name};let _=K[P.id];return _?{...P,color:_}:P}),k=J.groups.map((P)=>P.id===q?{...P,memberIds:O,originalColors:j,originalNames:F,primaryMemberId:X}:P);return{state:{...J,categories:A,groups:k},history:z}}function CJ(J,Q,q){let Z=J.groups.find((z)=>z.id===q);if(!Z)return{state:J,history:Q};let K=v(Q,J),X=J.groups.filter((z)=>z.id!==q),U=J.categories.map((z)=>{let O=Z.originalColors[z.id],V=Z.originalNames[z.id];return O?{...z,color:O,name:V??z.name}:z});return{state:{...J,categories:U,groups:X},history:K}}function $J(J){if(Array.isArray(J))return{grid:J};if(!J||!Array.isArray(J.grid))return{grid:Array(168).fill("unassigned")};return J}function IJ(J,Q){if(Q.past.length===0)return{state:J,history:Q};let q=[...Q.past],Z=$J(q.pop());return{state:{...J,grid:Z.grid,...Z.categories?{categories:Z.categories.map((X)=>({...X}))}:{},...Z.groups?{groups:Z.groups.map((X)=>({...X,memberIds:[...X.memberIds],originalColors:X.originalColors?{...X.originalColors}:{},originalNames:X.originalNames?{...X.originalNames}:{}}))}:{}},history:{past:q,future:[UJ(J,!0),...Q.future]}}}function bJ(J,Q){if(Q.future.length===0)return{state:J,history:Q};let q=[...Q.future],Z=$J(q.shift());return{state:{...J,grid:Z.grid,...Z.categories?{categories:Z.categories.map((X)=>({...X}))}:{},...Z.groups?{groups:Z.groups.map((X)=>({...X,memberIds:[...X.memberIds],originalColors:X.originalColors?{...X.originalColors}:{},originalNames:X.originalNames?{...X.originalNames}:{}}))}:{}},history:{past:[...Q.past,UJ(J,!0)],future:q}}}function OJ(J){try{localStorage.setItem("168hours",JSON.stringify(J))}catch{console.warn("Failed to save state to localStorage")}}function FJ(){try{let J=localStorage.getItem("168hours");if(!J)return null;let Q=JSON.parse(J);if(!Array.isArray(Q.grid)||Q.grid.length!==168||!Array.isArray(Q.categories))return null;if(!Q.categories.find((q)=>q.id==="unassigned"))Q.categories.unshift({id:"unassigned",name:"Unassigned",color:"#9ca3af"});if(typeof Q.trackingMode!=="boolean")Q.trackingMode=!1;if(!Array.isArray(Q.types))Q.types=[];Q.types=Q.types.filter((q)=>q&&typeof q.id==="string"&&typeof q.name==="string").map((q)=>({id:q.id,name:q.name}));if(!Q.categoryTypes||typeof Q.categoryTypes!=="object")Q.categoryTypes={};let tIds=new Set(Q.types.map((q)=>q.id)),cIds=new Set(Q.categories.map((q)=>q.id));Q.categoryTypes=Object.fromEntries(Object.entries(Q.categoryTypes).map(([q,z])=>[q,Array.isArray(z)?z:z?[z]:[]]).map(([q,z])=>[q,z.filter((O)=>tIds.has(O))]).filter(([q,z])=>cIds.has(q)&&q!=="unassigned"&&z.length>0));if(!Array.isArray(Q.cellChunks)||Q.cellChunks.length!==168)Q.cellChunks=Array(168).fill(1);if(!Array.isArray(Q.gridChunks)||Q.gridChunks.length!==168){Q.gridChunks=Q.grid.map((q)=>[q||"unassigned"]);for(let q=0;q<168;q++){let z=Q.cellChunks[q]||1;if(z>1&&Q.gridChunks[q].length===1){let K=Q.gridChunks[q][0];Q.gridChunks[q]=Array(z).fill(K)}}}return Q.groups=hJ(Q.groups,Q.categories),Q}catch{return null}}function hJ(J,Q){if(!Array.isArray(J))return[];let q=new Set(Q.map((Z)=>Z.id));return J.filter((Z)=>typeof Z==="object"&&Z!==null&&typeof Z.id==="string"&&typeof Z.name==="string"&&Array.isArray(Z.memberIds)).map((Z)=>{let K=Z.memberIds.filter((U)=>q.has(U)&&U!=="unassigned"),X=typeof Z.primaryMemberId==="string"&&q.has(Z.primaryMemberId)?Z.primaryMemberId:K[0]??"unassigned";return{id:Z.id,name:Z.name,memberIds:K,originalColors:Z.originalColors&&typeof Z.originalColors==="object"?Object.fromEntries(Object.entries(Z.originalColors).filter(([U,z])=>q.has(U)&&typeof z==="string")):{},color:typeof Z.color==="string"?Z.color:"#9ca3af",originalNames:Z.originalNames&&typeof Z.originalNames==="object"?Object.fromEntries(Object.entries(Z.originalNames).filter(([U,z])=>q.has(U)&&typeof z==="string")):{},primaryMemberId:K.includes(X)?X:K[0]??"unassigned"}}).filter((Z)=>Z.memberIds.length>=2)}function cJ(J,Q){let q=EJ(Q,J.grid);return{state:{...J,grid:Array(168).fill("unassigned")},history:q}}function pJ(J,Q){let q=new Set(qJ.map((z)=>z.id)),Z=v(Q,J),K=Array(168).fill("unassigned"),X=[...qJ.map((z)=>({...z}))],U="unassigned";if(typeof J.activeCategoryId==="string"&&q.has(J.activeCategoryId))U=J.activeCategoryId;let W=Array(168).fill(null).map(()=>["unassigned"]);return{state:{...J,categories:X,groups:[],grid:K,gridChunks:W,cellChunks:Array(168).fill(1),activeCategoryId:U,eraserMode:!1,trackingMode:J.trackingMode??!1,types:[],categoryTypes:{}},history:Z}}var PQ="6",KJ="168h:";function RQ(J){let Q=[];if(J.length===0)return Q;let q=J[0],Z=1;for(let K=1;K<J.length;K++)if(J[K]===q)Z++;else Q.push([Z,q]),q=J[K],Z=1;return Q.push([Z,q]),Q}function y(J){let Q=[];for(let[q,Z]of J)for(let K=0;K<q;K++)Q.push(Z);return Q}function LQ(J){return J.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function GQ(J){let Q=J.replace(/-/g,"+").replace(/_/g,"/");while(Q.length%4)Q+="=";return Q}function uJ(J){let Q=RQ(J.grid),q={version:PQ,categories:J.categories,groups:J.groups,types:Array.isArray(J.types)?J.types:[],categoryTypes:J.categoryTypes&&typeof J.categoryTypes==="object"?J.categoryTypes:{},grid:Q,cellChunks:Array.isArray(J.cellChunks)?J.cellChunks:Array(168).fill(1),gridChunks:Array.isArray(J.gridChunks)?J.gridChunks.map((c)=>Array.isArray(c)?[...c]:[c||"unassigned"]):Array(168).fill(null).map(()=>["unassigned"])},Z=JSON.stringify(q),K=btoa(Z),X=LQ(K);return`${KJ}${X}`}function yJ(J){try{if(!J.startsWith(KJ))return null;let Q=J.slice(KJ.length),q;try{let z=GQ(Q);q=atob(z)}catch{try{q=atob(Q)}catch{return null}}let Z=JSON.parse(q),K;if(Z.version==="6"&&Array.isArray(Z.grid)&&Z.grid.length>0&&Array.isArray(Z.grid[0]))K=y(Z.grid);else if(Z.version==="5"&&Array.isArray(Z.grid)&&Z.grid.length>0&&Array.isArray(Z.grid[0]))K=y(Z.grid);else if(Z.version==="4"&&Array.isArray(Z.grid)&&Z.grid.length>0&&Array.isArray(Z.grid[0]))K=y(Z.grid);else if(Z.version==="3"&&Array.isArray(Z.grid)&&Z.grid.length>0&&Array.isArray(Z.grid[0]))K=y(Z.grid);else if(Z.version==="2"&&Array.isArray(Z.grid)&&Z.grid.length>0&&Array.isArray(Z.grid[0]))K=y(Z.grid);else if(Z.version==="1"&&Array.isArray(Z.grid))K=Z.grid;else return null;if(!Z.version||!Array.isArray(Z.categories)||!Array.isArray(K)||K.length!==168)return null;if(!Z.categories.find((z)=>z.id==="unassigned"))Z.categories.unshift({id:"unassigned",name:"Unassigned",color:"#9ca3af"});let X=new Set(Z.categories.map((z)=>z.id));for(let z=0;z<K.length;z++)if(!X.has(K[z]))K[z]="unassigned";let U=hJ(Z.groups,Z.categories),types=Array.isArray(Z.types)?Z.types.filter((c)=>c&&typeof c.id==="string"&&typeof c.name==="string").map((c)=>({id:c.id,name:c.name})):[],typeIds=new Set(types.map((c)=>c.id)),categoryTypes=Z.categoryTypes&&typeof Z.categoryTypes==="object"?Object.fromEntries(Object.entries(Z.categoryTypes).map(([c,t])=>[c,Array.isArray(t)?t:t?[t]:[]]).map(([c,t])=>[c,t.filter((O)=>typeIds.has(O))]).filter(([c,t])=>c!=="unassigned"&&X.has(c)&&t.length>0)):{};let cellChunks=Array.isArray(Z.cellChunks)&&Z.cellChunks.length===168?[...Z.cellChunks]:Array(168).fill(1);let gridChunks=Array.isArray(Z.gridChunks)&&Z.gridChunks.length===168?Z.gridChunks.map((c)=>Array.isArray(c)?[...c]:[c||"unassigned"]):K.map((c)=>[c||"unassigned"]);return{categories:Z.categories,groups:U,types:types,categoryTypes:categoryTypes,grid:K,cellChunks:cellChunks,gridChunks:gridChunks,activeCategoryId:"unassigned",eraserMode:!1,trackingMode:!1}}catch(e){console.error("yJ parse error:",e);return null}}function fQ(J){let Q=J.slice(1).match(/.{2}/g);if(!Q||Q.length!==3)return 0;let q=Q.map((Z)=>{let K=parseInt(Z,16)/255;return K<=0.03928?K/12.92:Math.pow((K+0.055)/1.055,2.4)});return 0.2126*q[0]+0.7152*q[1]+0.0722*q[2]}function kJ(J){return fQ(J)>0.4}function WJ(J,Q,q){return Math.min(q,Math.max(Q,J))}function HQ(J){let Q=J.slice(1).match(/.{2}/g);if(!Q||Q.length!==3)return[0,0,0];return[parseInt(Q[0],16),parseInt(Q[1],16),parseInt(Q[2],16)]}function MQ(J,Q,q){let Z=J/255,K=Q/255,X=q/255,U=Math.max(Z,K,X),z=Math.min(Z,K,X),O=U-z,V=0,W=0,j=(U+z)/2;if(O!==0){switch(W=j>0.5?O/(2-U-z):O/(U+z),U){case Z:V=(K-X)/O+(K<X?6:0);break;case K:V=(X-Z)/O+2;break;default:V=(Z-K)/O+4;break}V*=60}return[V,W*100,j*100]}function EQ(J,Q,q){let Z=Q/100,K=q/100,X=(1-Math.abs(2*K-1))*Z,U=J/60,z=X*(1-Math.abs(U%2-1)),O=0,V=0,W=0;if(U>=0&&U<1)O=X,V=z;else if(U>=1&&U<2)O=z,V=X;else if(U>=2&&U<3)V=X,W=z;else if(U>=3&&U<4)V=z,W=X;else if(U>=4&&U<5)O=z,W=X;else if(U>=5&&U<6)O=X,W=z;let j=K-X/2,F=(A)=>Math.round((A+j)*255).toString(16).padStart(2,"0");return`#${F(O)}${F(V)}${F(W)}`}var iJ="first-day-of-week";function TQ(){try{let Q=new Intl.Locale(navigator.language);if("weekInfo"in Q){let q=Q.weekInfo;if(q&&typeof q.firstDay==="number")return q.firstDay}}catch{}let J=navigator.language.toLowerCase();if(J.startsWith("en-us")||J.startsWith("en-ca")||J.startsWith("en-au")||J.startsWith("ja"))return 7;return 1}function DQ(){let J=localStorage.getItem(iJ);if(J){let Q=parseInt(J,10);if(Q>=1&&Q<=7)return Q}return TQ()}function vQ(J){if(J>=1&&J<=7)localStorage.setItem(iJ,String(J)),s=J}var s=null;function e(){if(s===null)s=DQ();return s}var sJ="day-start-time",BQ=4;function SQ(){let J=localStorage.getItem(sJ);if(J){let Q=parseInt(J,10);if(Q>=0&&Q<=23)return Q}return BQ}function xQ(J){if(J>=0&&J<=23)localStorage.setItem(sJ,String(J)),o=J}var o=null;function JJ(){if(o===null)o=SQ();return o}function oJ(J){let Q=e();return((Q===7?6:Q-1)+J)%7}function wQ(J){let Q=e(),q=Q===7?6:Q-1;return(J-q+7)%7}function CQ(){let J=e(),Q=new Intl.DateTimeFormat(navigator.language,{weekday:"short"}),q=[],Z=new Date(2024,0,1),K=J===7?6:J-1;for(let X=0;X<7;X++){let U=(K+X)%7,z=new Date(Z);z.setDate(Z.getDate()+U),q.push(Q.format(z))}return q}function d(J,Q){let q=JJ(),Z=(J+q)%24;return oJ(Q)*24+Z}function l(J){let Q=Math.floor(J/24),q=J%24,Z=JJ(),K=(q-Z+24)%24,X=wQ(Q);return{row:K,col:X}}function $Q(J){let{row:Q,col:q}=l(J),Z=[];if(Q>0)Z.push(d(Q-1,q));if(Q<23)Z.push(d(Q+1,q));if(q>0)Z.push(d(Q,q-1));if(q<6)Z.push(d(Q,q+1));return Z}function IQ(J){let Q=new Set,q=[];if(!J||J.length!==168)return[];for(let Z=0;Z<168;Z++){if(Q.has(Z))continue;let K=J[Z];if(K===void 0)continue;if(K===w){Q.add(Z);continue}let X=new Set,U=[Z];while(U.length>0){let z=U.pop();if(Q.has(z))continue;if(J[z]!==K)continue;Q.add(z),X.add(z);for(let O of $Q(z))if(!Q.has(O)&&J[O]===K)U.push(O)}if(X.size>=2){let z=0,O=0;for(let _ of X){let{row:R,col:H}=l(_);z+=R,O+=H}let V=z/X.size,W=O/X.size,j=Z,F=1/0;for(let _ of X){let{row:R,col:H}=l(_),T=Math.pow(R-V,2)+Math.pow(H-W,2);if(T<F)F=T,j=_}let A=Math.round(V),k=[...X].filter((_)=>l(_).row===A),P=1;if(k.length>0){let _=k.map((R)=>l(R).col);P=Math.max(..._)-Math.min(..._)+1}q.push({categoryId:K,cells:X,centerIndex:j,colSpan:P})}}return q}var Y=null;try{Y=FJ()??n()}catch(e){console.error("Failed to initialize state:",e),Y=n()}if(!Y||typeof Y!=="object"){Y=n()}if(!Array.isArray(Y.cellChunks)||Y.cellChunks.length!==168)Y.cellChunks=Array(168).fill(1);if(!Array.isArray(Y.gridChunks)||Y.gridChunks.length!==168)Y.gridChunks=Y.grid.map((q)=>[q||"unassigned"]);if(!Array.isArray(Y.types))Y.types=[];if(!Y.categoryTypes||typeof Y.categoryTypes!=="object")Y.categoryTypes={};var N=XJ(),x=new Set,a=document.getElementById("grid"),b=document.getElementById("legend"),mJ=document.getElementById("hour-labels"),lJ=document.getElementById("day-labels"),aJ=document.getElementById("undo-btn"),tJ=document.getElementById("redo-btn"),bQ=document.getElementById("erase-all-btn"),p=document.getElementById("copy-summary-btn"),D=document.getElementById("export-png-btn"),B=document.getElementById("export-calendar-btn"),u=document.getElementById("import-calendar-btn"),rJ=document.getElementById("eraser-btn"),hQ=document.getElementById("add-category-btn"),cQ=document.getElementById("reset-categories-btn"),n0=document.getElementById("add-type-btn"),r0=document.getElementById("type-list"),s0=document.getElementById("type-totals"),eJ=document.getElementById("merge-categories-btn"),JQ=document.getElementById("clear-merge-selection-btn"),h=document.getElementById("category-dialog"),pQ=document.getElementById("dialog-title"),QQ=document.getElementById("dialog-submit"),uQ=document.getElementById("dialog-cancel"),AJ=document.getElementById("category-name"),ZQ=document.getElementById("category-color"),yQ=document.getElementById("resize-handle"),RJ=document.querySelector(".sidebar"),S=document.getElementById("sidebar-toggle"),gJ=document.querySelector(".grid-container"),_J=document.getElementById("week-start-select"),NJ=document.getElementById("day-start-select"),C=document.getElementById("version"),qQ=document.getElementById("tracking-mode-btn"),c=document.getElementById("share-btn"),jJ=null;function L(){if(jJ)clearTimeout(jJ);jJ=setTimeout(()=>OJ(Y),100)}var KQ="sidebar-width",mQ=280,lQ=200,gQ=500;function XQ(){let J=localStorage.getItem(KQ);return J?parseInt(J,10):mQ}function UQ(J){let Q=Math.max(lQ,Math.min(gQ,J));document.documentElement.style.setProperty("--sidebar-width",`${Q}px`),localStorage.setItem(KQ,String(Q))}var t=!1,zQ=0,YQ=0;yQ.addEventListener("mousedown",(J)=>{J.preventDefault(),t=!0,zQ=J.clientX,YQ=XQ(),document.body.style.cursor="col-resize",document.body.style.userSelect="none"});document.addEventListener("mousemove",(J)=>{if(!t)return;let Q=J.clientX-zQ,q=YQ+Q;UQ(q)});document.addEventListener("mouseup",()=>{if(t)t=!1,document.body.style.cursor="",document.body.style.userSelect=""});UQ(XQ());function nQ(J){let Q=J===0?12:J>12?J-12:J,q=J<12?"am":"pm";return`${Q}${q}`}function VQ(J){let Q=JJ();return(J+Q)%24}function OQ(){mJ.innerHTML="";for(let J=0;J<24;J++){let Q=VQ(J),q=document.createElement("div");q.className="hour-label",q.textContent=nQ(Q),mJ.appendChild(q)}}function LJ(){lJ.innerHTML="";let J=CQ();for(let Q of J){let q=document.createElement("span");q.textContent=Q,lJ.appendChild(q)}}function M(){if(!Y||typeof Y!=="object"){Y=FJ()??n()}if(!a){console.error("Grid element not found"),a=document.getElementById("grid")}if(!a)return;if(!Array.isArray(Y.grid)||Y.grid.length!==168)console.error("Invalid state.grid detected, reinitializing:",Y.grid),Y.grid=Array(168).fill(w);if(!Array.isArray(Y.cellChunks)||Y.cellChunks.length!==168)Y.cellChunks=Array(168).fill(1);if(!Array.isArray(Y.gridChunks)||Y.gridChunks.length!==168){Y.gridChunks=Y.grid.map((q)=>[q||"unassigned"]);for(let q=0;q<168;q++){let z=Y.cellChunks[q]||1;if(z>1&&Y.gridChunks[q].length===1){let K=Y.gridChunks[q][0];Y.gridChunks[q]=Array(z).fill(K)}}}a.innerHTML="";let J=IQ(Y.grid),Q=new Map;for(let q of J){let Z=E(Y,q.categoryId);if(Z)Q.set(q.centerIndex,{name:Z.name,colSpan:q.colSpan})}for(let q=0;q<24;q++){let Z=VQ(q);for(let K=0;K<7;K++){let U=oJ(K)*24+Z,z=Y.grid[U],O=E(Y,z),V=O?.color??"#9ca3af",W=document.createElement("div");W.className="cell",W.dataset.index=String(U);let j=Y.cellChunks[U]||1;if(j>1){W.style.backgroundColor="transparent",W.style.display="flex",W.style.flexDirection="column";let F=document.createElement("div");F.className=`cell-chunks cell-chunks-${j}`;let X=Y.gridChunks[U]||[z||"unassigned"];for(let A=0;A<j;A++){let k=document.createElement("div");let P=X[A]||z||"unassigned",_=E(Y,P),R=_?.color??"#9ca3af";k.className="cell-chunk",k.style.backgroundColor=R,k.dataset.index=String(U),k.dataset.chunkIndex=String(A);let H=Q.get(U);if(H&&A===0){let T=document.createElement("span");T.className="cell-label",T.textContent=H.name,T.style.color=kJ(R)?"rgba(0,0,0,0.55)":"rgba(255,255,255,0.75)",k.appendChild(T)}F.appendChild(k)}W.appendChild(F)}else{W.style.backgroundColor=V;let F=Q.get(U);if(F){let A=document.createElement("span");A.className="cell-label",A.textContent=F.name,A.style.color=kJ(V)?"rgba(0,0,0,0.55)":"rgba(255,255,255,0.75)",F.colSpan>1?A.style.width=`${F.colSpan*100}%`:void 0,W.appendChild(A)}if(Y.trackingMode){let A=document.createElement("div");A.className="cell-tracking-top",A.style.backgroundColor=V;let k=document.createElement("span");k.className="cell-tracking-label",k.textContent=O?.name??"",k.style.color=kJ(V)?"rgba(0,0,0,0.7)":"rgba(255,255,255,0.9)",A.appendChild(k);let P=document.createElement("div");P.className="cell-tracking-bottom";let _=document.createElement("span");_.className="cell-tracking-checkbox",_.textContent="â—‹";let R=document.createElement("span");R.className="cell-tracking-line",P.appendChild(_),P.appendChild(R),W.appendChild(A),W.appendChild(P)}}a.appendChild(W)}}}function QJ(J){if(J.length===0)return null;return J.map((Q)=>({member:Q,count:m(Y,Q.id)})).sort((Q,q)=>q.count-Q.count)[0]?.member??null}function dQ(J){return J.map((Q)=>Q.color)}function FQ(){let J=new Set,Q=Array.isArray(Y.groups)?Y.groups:[],q=[];for(let O of Q){let V=O.memberIds.map((_)=>E(Y,_)).filter((_)=>Boolean(_));if(V.length<2)continue;V.forEach((_)=>J.add(_.id));let W=V.reduce((_,R)=>_+m(Y,R.id),0),j=Math.round(W/168*100),F=(W/7).toFixed(1).replace(/\.0$/,""),A=V.find((_)=>_.id===O.primaryMemberId)??QJ(V),k=O.color||A?.color||V[0].color,P=dQ(V);q.push({type:"group",group:O,members:V,totalCount:W,percent:j,avgPerDay:F,palette:P,primaryColor:k})}let K=m(Y,w)>0,X=Y.categories.filter((O)=>!J.has(O.id)).map((O)=>{let V=m(Y,O.id),W=Math.round(V/168*100),j=O.id===w,F=(V/7).toFixed(1).replace(/\.0$/,"");return{type:"category",category:O,count:V,percent:W,avgPerDay:F,isUnassigned:j}}).filter((O)=>{if(O.type!=="category")return!1;if(O.isUnassigned&&(O.count===0||O.percent===0))return!1;return!0}),z=[...q,...X].sort((O,V)=>{let W=O.type==="group"?O.percent:O.percent,j=V.type==="group"?V.percent:V.percent;if(W!==j)return j-W;let F=O.type==="group"?O.group.name:O.category.name,A=V.type==="group"?V.group.name:V.category.name;return F.localeCompare(A)});if(K)return z;return z}function iQ(J){return Y.groups.some((Q)=>Q.memberIds.includes(J))}function GJ(){return Array.from(x).filter((J)=>J!==w&&E(Y,J)&&!iQ(J))}function WQ(){let J=GJ();x=new Set(J),eJ.disabled=J.length<2,JQ.disabled=J.length===0}function sQ(J){let Q=J.map((K)=>E(Y,K)).filter((K)=>Boolean(K));if(Q.sort((K,X)=>K.name.localeCompare(X.name)),Q.length===0)return"Merged Group";if(Q.length===2)return`${Q[0].name} + ${Q[1].name}`;return`${QJ(Q)?.name??Q[0].name} + ${Q.length-1} more`}function g(J,Q,q){let Z=J.map((W)=>E(Y,W)).filter((W)=>Boolean(W));if(Z.length===0)return{};let[K,X,U]=MQ(...HQ(Q)),z=14,O={};return[...Z].sort((W,j)=>{if(W.id===q)return-1;if(j.id===q)return 1;return W.name.localeCompare(j.name)}).forEach((W,j)=>{if(W.id===q){O[W.id]=Q;return}let F=Math.ceil(j/2),A=j%2===0?1:-1,k=WJ(F*6,4,z)*A,P=A*4,_=(K+k+360)%360,R=WJ(X+2,40,85),H=WJ(U+P,30,78);O[W.id]=EQ(_,R,H)}),O}function G(){if(!Y||typeof Y!=="object"){Y=FJ()??n()}if(b.innerHTML="",RJ.classList.contains("collapsed")){let J=E(Y,Y.activeCategoryId);if(J)S.style.backgroundColor=J.color,S.style.borderColor=J.color,S.style.color=kJ(J.color)?"rgba(0,0,0,0.7)":"rgba(255,255,255,0.9)";else S.style.backgroundColor="",S.style.borderColor="",S.style.color=""}else S.style.backgroundColor="",S.style.borderColor="",S.style.color="";for(let J of FQ()){if(J.type==="group"){let X=J.totalCount>0?`${J.totalCount}h Â· ${J.avgPerDay}/day`:`${J.totalCount}h`,U=document.createElement("div");U.className="category-item category-group",U.dataset.groupId=J.group.id;let z=J.members.map((O,V)=>{let W=J.palette[V]??O.color;return`
            <div class="category-member">
              <button class="category-member-select${O.id===Y.activeCategoryId?" active":""}" data-id="${O.id}" title="Select ${i(O.name)}">
                <span class="category-member-dot" style="background:${W}"></span>
                ${i(O.name)}
              </button>
              <button class="category-member-remove" data-id="${O.id}" data-group-id="${J.group.id}" title="Remove from group">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>
          `}).join("");U.innerHTML=`
        <div class="category-color-wrapper">
          <input type="color" class="category-color category-group-color" value="${J.group.color}" data-group-id="${J.group.id}">
          <button class="category-randomize" data-group-id="${J.group.id}" title="Randomize color">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/>
              <path d="m18 2 4 4-4 4"/>
              <path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"/>
              <path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/>
              <path d="m18 14 4 4-4 4"/>
            </svg>
          </button>
        </div>
        <div class="category-info">
          <div class="category-name category-group-name" data-group-id="${J.group.id}">${i(J.group.name)} â€” ${J.percent}%</div>
          <div class="category-stats">${X}</div>
          <div class="category-members">${z}</div>
        </div>
        <button class="category-group-add" data-group-id="${J.group.id}" title="Add selected categories">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
        <button class="category-unmerge" data-group-id="${J.group.id}" title="Unmerge categories">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7h7l-2-2M3 7l2 2"/>
            <path d="M21 17h-7l2 2M21 17l-2-2"/>
            <path d="M7 11v2a4 4 0 0 0 4 4h2"/>
            <path d="M17 13v-2a4 4 0 0 0-4-4h-2"/>
          </svg>
        </button>
      `,b.appendChild(U);continue}let Q=Y.activeCategoryId===J.category.id,q=x.has(J.category.id),Z=J.count>0?`${J.count}h Â· ${J.avgPerDay}/day`:`${J.count}h`,K=document.createElement("div");K.className=`category-item${Q?" active":""}${q?" merge-selected":""}`,K.dataset.id=J.category.id,K.innerHTML=`
      <div class="category-color-wrapper">
        <input type="color" class="category-color" value="${J.category.color}" data-id="${J.category.id}">
        <button class="category-randomize" data-id="${J.category.id}" title="Randomize color">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/>
            <path d="m18 2 4 4-4 4"/>
            <path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"/>
            <path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/>
            <path d="m18 14 4 4-4 4"/>
          </svg>
        </button>
      </div>
      <div class="category-info">
        <div class="category-name" data-id="${J.category.id}">${i(J.category.name)} â€” ${J.percent}%</div>
        <div class="category-stats">${Z}</div>
        ${!J.isUnassigned?`<div class="category-type-tags">${p0(J.category.id)}</div>`:""}
      </div>
      ${!J.isUnassigned?`<button class="category-merge" data-id="${J.category.id}" title="${q?"Remove from merge selection":"Select for merging"}">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M7 7h10M7 12h10M7 17h10"/>
        </svg>
      </button>`:""}
      ${!J.isUnassigned?`<button class="category-edit" data-id="${J.category.id}" title="Rename category">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
          <path d="m15 5 4 4"/>
        </svg>
      </button>`:""}
      ${!J.isUnassigned?`<button class="category-delete" data-id="${J.category.id}" title="Delete category">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>`:""}
    `,b.appendChild(K)}let _types=Array.isArray(Y.types)?Y.types:[],_categoryTypes=Y.categoryTypes&&typeof Y.categoryTypes==="object"?Y.categoryTypes:{},_totals=_types.map((J)=>{let Q=Y.categories.filter((q)=>q.id!==w&&Array.isArray(_categoryTypes[q.id])&&_categoryTypes[q.id].includes(J.id)).reduce((q,Z)=>q+m(Y,Z.id),0);return{type:J,hours:Math.round(Q*100)/100,percent:Math.round(Q/168*100)}}).filter((J)=>J.hours>0).sort((J,Q)=>Q.hours-J.hours||J.type.name.localeCompare(Q.type.name));l0(_totals);t0(),WQ()}function f(){if(!Y||typeof Y!=="object"){Y=FJ()??n()}if(!N||typeof N!=="object"){N=XJ()}aJ.disabled=N.past.length===0,tJ.disabled=N.future.length===0,rJ.classList.toggle("active",Y.eraserMode),qQ.classList.toggle("active",Y.trackingMode),document.body.classList.toggle("tracking-mode",Y.trackingMode)}function $(){if(!Y||typeof Y!=="object"){Y=n()}LJ(),M(),G(),f()}function i(J){return J.replace(/[&<>"']/g,(Q)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[Q]??Q)}function oQ(){return`cat-${Date.now()}-${Math.random().toString(36).slice(2,7)}`}function aQ(){return`group-${Date.now()}-${Math.random().toString(36).slice(2,7)}`}function e0(){return`type-${Date.now()}-${Math.random().toString(36).slice(2,7)}`}function p0(J){let Q=Y.categoryTypes&&typeof Y.categoryTypes==="object"?Y.categoryTypes[J]:[],q=Array.isArray(Q)?Q:Q?[Q]:[];return(Array.isArray(Y.types)?Y.types:[]).map((Z)=>`<button class="category-type-tag${q.includes(Z.id)?" active":""}" data-id="${J}" data-type-id="${Z.id}" type="button">${i(Z.name)}</button>`).join("")}function t0(){if(!r0)return;let J=Array.isArray(Y.types)?Y.types:[];r0.innerHTML=J.length===0?`<span class="type-pill">No types yet</span>`:J.map((Q)=>`<span class="type-pill">${i(Q.name)}</span>`).join("")}function l0(J){if(!s0)return;if(!Array.isArray(J)||J.length===0){s0.innerHTML="";return}s0.innerHTML=J.map((Q)=>`<span class="type-total-pill">${i(Q.type.name)} ${Q.hours}h (${Q.percent}%)</span>`).join("")}function nJ(J){let Q=J.slice(1).match(/.{2}/g);if(!Q||Q.length!==3)return"â¬›";let q=Q.map((V)=>parseInt(V,16)),Z=q[0]??0,K=q[1]??0,X=q[2]??0,U=[["\uD83D\uDFE6",[52,152,219]],["\uD83D\uDFE9",[46,204,113]],["\uD83D\uDFE8",[241,196,15]],["\uD83D\uDFE7",[230,126,34]],["\uD83D\uDFE5",[231,76,60]],["\uD83D\uDFEA",[155,89,182]],["â¬›",[44,62,80]],["â¬œ",[236,240,241]],["\uD83D\uDFEB",[141,85,36]],["\uD83D\uDD35",[41,128,185]],["\uD83D\uDFE2",[39,174,96]],["\uD83D\uDFE1",[241,196,15]],["\uD83D\uDFE0",[230,126,34]],["\uD83D\uDD34",[192,57,43]],["\uD83D\uDFE3",[142,68,173]]],z=1/0,O="â¬›";for(let[V,[W,j,F]]of U){let A=Math.sqrt(Math.pow(Z-W,2)+Math.pow(K-j,2)+Math.pow(X-F,2));if(A<z)z=A,O=V}return O}function tQ(J="hybrid"){let Q=[],q=FQ(),Z=new Map;q.forEach((X)=>{if(X.type==="group")Z.set(X.group.id,nJ(X.primaryColor));else Z.set(X.category.id,nJ(X.category.color))});let K=40;for(let X of q){let U=X.type==="group"?X.totalCount:X.count,z=X.type==="group"?X.percent:X.percent,O=X.type==="group"?X.avgPerDay:X.avgPerDay,V=X.type==="group"?Z.get(X.group.id)||"â¬›":Z.get(X.category.id)||"â¬›",W=X.type==="group"?X.group.name:X.category.name,j=Math.round(z/100*K),F=V.repeat(j);Q.push(`${F} ${W} ${z}% Â· ${U}h Â· ${O}/day`)}return Q.join(`
`)}async function rQ(){let J=tQ("hybrid");if(await HJ(J)){let q=p.innerHTML;p.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    `,p.style.color="var(--accent)",setTimeout(()=>{p.innerHTML=q,p.style.color=""},2000)}else alert(`Failed to copy. Please copy manually:

`+J)}function eQ(){return new Promise((J,Q)=>{if(typeof window.html2canvas==="function"){J(window.html2canvas);return}if(document.querySelector("script[data-html2canvas]")){let K=setInterval(()=>{if(typeof window.html2canvas==="function")clearInterval(K),J(window.html2canvas)},100);setTimeout(()=>{clearInterval(K),Q(Error("Timeout waiting for html2canvas to load"))},1e4);return}let Z=document.createElement("script");Z.setAttribute("data-html2canvas","true"),Z.src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",Z.onload=()=>{if(typeof window.html2canvas==="function")J(window.html2canvas);else Q(Error("html2canvas loaded but not available"))},Z.onerror=()=>{Q(Error("Failed to load html2canvas script from CDN"))},document.head.appendChild(Z)})}async function J0(){if(!gJ){console.error("Grid container not found");return}let J=D.innerHTML;try{D.disabled=!0,D.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12 6 12 12 16 14"/>
      </svg>
    `;let q=await(await eQ())(gJ,{scale:2,backgroundColor:"#ffffff",useCORS:!0,logging:!1,allowTaint:!1});if(!q)throw Error("html2canvas returned null");let Z=await new Promise((z,O)=>{q.toBlob((V)=>{if(!V){O(Error("Failed to create blob from canvas"));return}z(V)},"image/png")}),K=URL.createObjectURL(Z),X=document.createElement("a"),U=new Date().toISOString().split("T")[0];X.download=`168hours-calendar-${U}.png`,X.href=K,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(K),D.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    `,D.style.color="var(--accent)",setTimeout(()=>{D.innerHTML=J,D.style.color="",D.disabled=!1},2000)}catch(Q){console.error("Failed to export PNG:",Q);let q=Q instanceof Error?Q.message:String(Q);alert(`Failed to export calendar as PNG: ${q}

Check the browser console for details.`),D.disabled=!1,D.innerHTML=J,D.style.color=""}}var fJ=!1,r=new Set;function jQ(J){if(!Array.isArray(Y.grid)||Y.grid.length!==168)Y.grid=Array(168).fill("unassigned");if(!Array.isArray(Y.gridChunks)||Y.gridChunks.length!==168){Y.gridChunks=Y.grid.map((q)=>[q||"unassigned"]);if(!Array.isArray(Y.cellChunks)||Y.cellChunks.length!==168)Y.cellChunks=Array(168).fill(1);for(let q=0;q<168;q++){let z=Y.cellChunks[q]||1;if(z>1&&Y.gridChunks[q].length===1){let K=Y.gridChunks[q][0];Y.gridChunks[q]=Array(z).fill(K)}}}let Q=J.closest(".cell,.cell-chunk");if(!Q)return;let q=parseInt(Q.dataset.index,10),z=Q.dataset.chunkIndex!==undefined?parseInt(Q.dataset.chunkIndex,10):null;if(z!==null){let K=Y.gridChunks[q]||[Y.grid[q]||"unassigned"];if(!Array.isArray(K)||K.length<=z)K=Array(Y.cellChunks[q]||1).fill(Y.grid[q]||"unassigned");if(K[z]===Y.activeCategoryId&&!Y.eraserMode)K[z]="unassigned";else if(Y.eraserMode)K[z]="unassigned";else K[z]=Y.activeCategoryId;let X=[...Y.gridChunks];X[q]=[...K];let U=[...Y.grid];U[q]=K[0]||"unassigned";Y={...Y,gridChunks:X,grid:U,cellChunks:[...Y.cellChunks]};N=v(N,Y);M(),G(),f(),L()}else{if(r.has(q))return;r.add(q);let K=Y.cellChunks[q]||1;if(K>1){let X=Y.gridChunks[q]||[Y.grid[q]||"unassigned"],U=Y.eraserMode?"unassigned":Y.activeCategoryId,W=Array(K).fill(U),j=[...Y.gridChunks];j[q]=W;let F=[...Y.grid];F[q]=U;Y={...Y,gridChunks:j,grid:F,cellChunks:[...Y.cellChunks]};N=v(N,Y);M(),G(),f(),L()}else{let X=TJ(Y,N,q);Y=X.state,N=X.history,M(),G(),f(),L()}}}a.addEventListener("mousedown",(J)=>{let Q=J.target.closest(".cell,.cell-chunk");if(!Q)return;J.preventDefault(),fJ=!0,r.clear(),jQ(Q)});a.addEventListener("mousemove",(J)=>{if(!fJ)return;let Q=J.target.closest(".cell,.cell-chunk");if(!Q)return;jQ(Q)});document.addEventListener("mouseup",()=>{fJ=!1,r.clear()});function cycleCellChunks(J){if(!Array.isArray(Y.grid)||Y.grid.length!==168)Y.grid=Array(168).fill("unassigned");if(!Array.isArray(Y.gridChunks)||Y.gridChunks.length!==168)Y.gridChunks=Y.grid.map((q)=>[q||"unassigned"]);if(!Array.isArray(Y.cellChunks)||Y.cellChunks.length!==168)Y.cellChunks=Array(168).fill(1);let Q=parseInt(J.dataset.index,10);if(Q<0||Q>=168)return;let q=Y.cellChunks[Q]||1,z=q===1?2:q===2?3:q===3?4:1,K=[...Y.cellChunks];K[Q]=z;let X=Y.gridChunks[Q]||[Y.grid[Q]||"unassigned"],U=[...Y.gridChunks];if(U[Q].length===1){let W=U[Q][0]||Y.grid[Q]||"unassigned";U[Q]=Array(z).fill(W)}else if(U[Q].length!==z){let W=U[Q][0]||Y.grid[Q]||"unassigned";U[Q]=Array(z).fill(W)}Y={...Y,cellChunks:K,gridChunks:U};N=v(N,Y);M(),G(),f(),L()}a.addEventListener("contextmenu",(J)=>{let Q=J.target.closest(".cell,.cell-chunk");if(!Q)return;J.preventDefault();let q=Q.closest(".cell");if(q)cycleCellChunks(q)});function Q0(J){if(J===w)return;let Q=E(Y,J);if(!Q)return;let q=b.querySelector(`.category-name[data-id="${J}"]`);if(!q)return;let Z=document.createElement("input");Z.type="text",Z.className="category-name-input",Z.value=Q.name,Z.maxLength=20,q.replaceWith(Z),Z.focus(),Z.select();let K=()=>{let X=Z.value.trim()||Q.name,U=vJ(Y,N,J,X);Y=U.state,N=U.history,M(),G(),f(),L()};Z.addEventListener("blur",K),Z.addEventListener("keydown",(X)=>{if(X.key==="Enter")X.preventDefault(),K();else if(X.key==="Escape")Z.value=Q.name,K()})}function Z0(J){let Q=Y.groups.find((X)=>X.id===J);if(!Q)return;let q=b.querySelector(`.category-group-name[data-group-id="${J}"]`);if(!q)return;let Z=document.createElement("input");Z.type="text",Z.className="category-name-input",Z.value=Q.name,Z.maxLength=24,q.replaceWith(Z),Z.focus(),Z.select();let K=()=>{let X=Z.value.trim()||Q.name,U=xJ(Y,N,J,X);Y=U.state,N=U.history,G(),f(),L()};Z.addEventListener("blur",K),Z.addEventListener("keydown",(X)=>{if(X.key==="Enter")X.preventDefault(),K();else if(X.key==="Escape")Z.value=Q.name,K()})}function PJ(){let J=Math.random(),Q=0.65+Math.random()*0.2,q=0.45+Math.random()*0.15,Z=Q*Math.min(q,1-q),K=(X)=>{let U=(X+J*12)%12,z=q-Z*Math.max(Math.min(U-3,9-U,1),-1);return Math.round(255*z).toString(16).padStart(2,"0")};return`#${K(0)}${K(8)}${K(4)}`}b.addEventListener("click",(J)=>{let Q=J.target,q=Q.closest(".category-group-add");if(q){J.stopPropagation();let F=q.dataset.groupId,A=Y.groups.find((R)=>R.id===F);if(!A)return;let k=GJ();if(k.length===0)return;let P=g([...A.memberIds,...k],A.color,A.primaryMemberId),_=wJ(Y,N,F,k,P,A.primaryMemberId);Y=_.state,N=_.history,MJ(),M(),G(),f(),L();return}let Z=Q.closest(".category-group-name");if(Z){J.stopPropagation();let F=Z.dataset.groupId;Z0(F);return}let K=Q.closest(".category-member-remove");if(K){J.stopPropagation();let F=K.dataset.groupId,A=K.dataset.id,k=Y.groups.find((T)=>T.id===F);if(!k)return;let P=k.memberIds.filter((T)=>T!==A);if(P.length<2){let T=VJ(Y,N,F,A,{},k.primaryMemberId);Y=T.state,N=T.history,M(),G(),f(),L();return}let _=A===k.primaryMemberId?QJ(P.map((T)=>E(Y,T)).filter((T)=>Boolean(T)))?.id??P[0]:k.primaryMemberId,R=g(P,k.color,_),H=VJ(Y,N,F,A,R,_);Y=H.state,N=H.history,M(),G(),f(),L();return}let X=Q.closest(".category-unmerge");if(X){J.stopPropagation();let F=X.dataset.groupId,A=CJ(Y,N,F);Y=A.state,N=A.history,M(),G(),f(),L();return}let U=Q.closest(".category-member-select");if(U){J.stopPropagation();let F=U.dataset.id;Y.activeCategoryId=F,Y.eraserMode=!1,G(),f(),L();return}let z=Q.closest(".category-randomize");if(z){J.stopPropagation();let F=z.dataset.groupId;if(F){let A=Y.groups.find((k)=>k.id===F);if(A){let k=PJ(),P=g(A.memberIds,k,A.primaryMemberId),_=YJ(Y,N,F,k,P);Y=_.state,N=_.history,M(),G(),f(),L()}}else{let A=z.dataset.id,k=zJ(Y,N,A,PJ());Y=k.state,N=k.history,M(),G(),f(),L()}return}let O=Q.closest(".category-merge");if(O){J.stopPropagation();let F=O.dataset.id;if(x.has(F))x.delete(F);else x.add(F);G();return}let V=Q.closest(".category-edit");if(V){J.stopPropagation(),Q0(V.dataset.id);return}let W=Q.closest(".category-delete");if(W){J.stopPropagation();let F=W.dataset.id,A=BJ(Y,N,F);Y=A.state,N=A.history,$(),C.textContent=I(),L();return}if(Q.classList.contains("category-color")||Q.classList.contains("category-group-color")||Q.classList.contains("category-type-select")||Q.classList.contains("category-type-tag"))return;let j=Q.closest(".category-item");if(j){if(j.classList.contains("category-group"))return;let F=j.dataset.id;Y.activeCategoryId=F,Y.eraserMode=!1,G(),f(),L()}});b.addEventListener("input",(J)=>{let Q=J.target;if(Q.classList.contains("category-group-color")){let q=Q.dataset.groupId,Z=Q.value,K=Y.groups.find((z)=>z.id===q);if(!K)return;let X=g(K.memberIds,Z,K.primaryMemberId),U=YJ(Y,N,q,Z,X);Y=U.state,N=U.history,M(),G(),f(),L();return}if(Q.classList.contains("category-color")){let q=Q.dataset.id,Z=Q.value,K=zJ(Y,N,q,Z);Y=K.state,N=K.history,M(),G(),f(),L()}});b.addEventListener("click",(J)=>{let Q=J.target.closest(".category-type-tag");if(!Q)return;J.preventDefault(),J.stopPropagation();let q=Q.dataset.id,Z=Q.dataset.typeId,K=Y.categoryTypes&&typeof Y.categoryTypes==="object"?{...Y.categoryTypes}:{};if(!q||!Z)return;let X=Array.isArray(K[q])?[...K[q]]:K[q]?[K[q]]:[],U=X.indexOf(Z);if(U>=0)X.splice(U,1);else X.push(Z);if(X.length===0)delete K[q];else K[q]=X;N=v(N,Y),Y={...Y,categoryTypes:K},M(),G(),f(),L()});aJ.addEventListener("click",()=>{let J=IJ(Y,N);Y=J.state,N=J.history,$(),C.textContent=I(),L()});tJ.addEventListener("click",()=>{let J=bJ(Y,N);Y=J.state,N=J.history,$(),C.textContent=I(),L()});bQ.addEventListener("click",()=>{let J=cJ(Y,N);Y=J.state,N=J.history,$(),C.textContent=I(),L()});rJ.addEventListener("click",()=>{if(Y.eraserMode=!Y.eraserMode,Y.eraserMode)Y.activeCategoryId=w;G(),f(),L()});qQ.addEventListener("click",()=>{Y.trackingMode=!Y.trackingMode,M(),f(),L()});p.addEventListener("click",()=>{rQ()});D.addEventListener("click",()=>{J0()});async function HJ(J){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(J),!0}catch(q){console.warn("Clipboard API failed, trying fallback:",q)}let Q=document.createElement("textarea");try{if(Q.value=J,Object.assign(Q.style,{position:"fixed",left:"0",top:"0",width:"2px",height:"2px",padding:"0",margin:"0",border:"none",outline:"none",opacity:"0",pointerEvents:"none",zIndex:"-9999",transform:"translateX(-100%)",overflow:"hidden",clip:"rect(0, 0, 0, 0)",clipPath:"inset(50%)"}),Q.setAttribute("readonly",""),Q.setAttribute("aria-hidden","true"),Q.setAttribute("tabindex","-1"),document.body.appendChild(Q),navigator.userAgent.match(/ipad|iphone/i)){let Z=document.createRange();Z.selectNodeContents(Q);let K=window.getSelection();K?.removeAllRanges(),K?.addRange(Z),Q.setSelectionRange(0,J.length)}else Q.select(),Q.setSelectionRange(0,J.length);let q=document.execCommand("copy");return window.getSelection()?.removeAllRanges(),q}catch(q){return console.warn("Fallback copy failed:",q),!1}finally{if(Q.parentNode)document.body.removeChild(Q)}}async function q0(){let J=uJ(Y);if(await HJ(J)){let q=B.innerHTML;B.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    `,B.style.color="var(--accent)",setTimeout(()=>{B.innerHTML=q,B.style.color=""},2000)}else if(prompt("Copy this calendar data (select all and copy):",J)===J){let Z=B.innerHTML;B.innerHTML=`
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      `,B.style.color="var(--accent)",setTimeout(()=>{B.innerHTML=Z,B.style.color=""},2000)}}function K0(){let J=prompt("Paste calendar data (Ctrl+V / Cmd+V):");if(!J)return;let Q=yJ(J.trim());if(!Q){alert("Invalid calendar data. Please check the format and try again.");return}let q=[...N.past,{grid:[...Y.grid],categories:Y.categories.map((K)=>({...K})),groups:Y.groups.map((K)=>({...K,memberIds:[...K.memberIds]}))}];if(q.length>50)q.shift();N={past:q,future:[]},Y=Q,x.clear(),$(),C.textContent=I(),OJ(Y);let Z=u.innerHTML;u.innerHTML=`
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="20 6 9 17 4 12"/>
    </svg>
  `,u.style.color="var(--accent)",setTimeout(()=>{u.innerHTML=Z,u.style.color=""},2000)}B.addEventListener("click",()=>{q0()});u.addEventListener("click",()=>{K0()});c.addEventListener("click",async()=>{if(await HJ("https://168hours-production.up.railway.app")){let Q=c.innerHTML;c.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <span>Share</span>
    `,c.style.color="#16a34a",setTimeout(()=>{c.innerHTML=Q,c.style.color=""},2000)}});function MJ(){x.clear(),WQ(),G()}eJ.addEventListener("click",()=>{let J=GJ();if(J.length<2)return;let Q=[...J].sort((V,W)=>{let j=E(Y,V)?.name??"",F=E(Y,W)?.name??"";return j.localeCompare(F)}),q=aQ(),Z=sQ(Q),K=QJ(Q.map((V)=>E(Y,V)).filter((V)=>Boolean(V))),X=K?.id??Q[0],U=K?.color??Y.categories.find((V)=>V.id===X)?.color??"#9ca3af",z=g(Q,U,X),O=SJ(Y,N,q,Z,Q,z,U,X);Y=O.state,N=O.history,MJ(),M(),f(),L()});JQ.addEventListener("click",()=>{MJ()});var X0=null;hQ.addEventListener("click",()=>{X0=null,pQ.textContent="Add Category",QQ.textContent="Add",AJ.value="",ZQ.value=PJ(),h.showModal(),AJ.focus()});n0&&n0.addEventListener("click",()=>{let J=prompt("Type name:","");if(!J)return;let Q=J.trim();if(!Q)return;let q=(Array.isArray(Y.types)?Y.types:[]).some((Z)=>Z.name.toLowerCase()===Q.toLowerCase());if(q){alert("That type already exists.");return}let Z={id:e0(),name:Q};N=v(N,Y),Y={...Y,types:[...(Array.isArray(Y.types)?Y.types:[]),Z]},G(),f(),L()});cQ.addEventListener("click",()=>{let J=pJ(Y,N);Y=J.state,N=J.history,x.clear(),$(),C.textContent=I(),L()});function kQ(){let J=AJ.value.trim();if(!J)return;if(!Y||!N)Y=FJ()??n(),N=XJ();let Q=ZQ.value,q=oQ();if(J===q){console.error("BUG: name equals id before calling addCategory!",{name:J,id:q}),alert("Bug detected: category name equals ID. Please report this.");return}let Z;try{Z=DJ(Y,N,q,J,Q)}catch(X){console.error("addCategory threw an error:",X),alert(`Error adding category: ${X instanceof Error?X.message:String(X)}`);return}if(!Z?.state){console.error("addCategory returned invalid result:",Z),alert("Failed to add category. Please try again.");return}let K=Z.state.categories[Z.state.categories.length-1];if(!K||K.name!==J){console.error("BUG: Created category has wrong name!",{expected:J,actual:K?.name,category:K}),alert(`Bug detected: Category name is "${K?.name}" but should be "${J}"`);return}Y=Z.state,N=Z.history,Y.activeCategoryId=q,Y.eraserMode=!1,$(),C.textContent=I(),L(),h.close()}uQ.addEventListener("click",()=>{h.close()});QQ.addEventListener("click",(J)=>{J.preventDefault(),kQ()});h.addEventListener("submit",(J)=>{J.preventDefault(),kQ()});h.addEventListener("click",(J)=>{if(J.target===h)h.close()});_J.value=String(e());_J.addEventListener("change",()=>{let J=parseInt(_J.value,10);vQ(J),LJ(),M()});NJ.value=String(JJ());NJ.addEventListener("change",()=>{let J=parseInt(NJ.value,10);xQ(J),OQ(),M()});var AQ="sidebar-collapsed";function U0(){return localStorage.getItem(AQ)==="true"}function _Q(J){localStorage.setItem(AQ,String(J)),RJ.classList.toggle("collapsed",J)}_Q(U0());S.addEventListener("click",()=>{let J=RJ.classList.contains("collapsed");_Q(!J),G()});var z0="v2025.365.0252",dJ="dev-build-version";function Y0(){let J=localStorage.getItem(dJ);if(J)return J;let Q=new Date,q=Q.getFullYear(),Z=new Date(q,0,1),K=Math.floor((Q.getTime()-Z.getTime())/86400000)+1,X=String(Q.getHours()).padStart(2,"0"),U=String(Q.getMinutes()).padStart(2,"0"),z=`v${q}.${String(K).padStart(3,"0")}.${X}${U}-dev`;return localStorage.setItem(dJ,z),z}function I(){return z0||Y0()}OQ();LJ();$();C.textContent=I();

  </script>
</body>
</html>
